<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<style>
  /* --- Variables & base --- */
  :root {
    --bg-dark: #0b0f14;
    --card-dark: #0f1720;
    --text-light: #e6eef8;
    --muted: #9fb2c8;
    --accent-blue: #2aa4ff;
    --accent-orange: #ff7a2d;
    --radius: 12px;
  }
  *{box-sizing:border-box;}
  body{margin:0; font-family:sans-serif; background:var(--bg-dark); color:var(--text-light); padding-top:64px;}
  header{position:fixed; top:0; width:100%; height:64px; background:rgba(15,23,32,0.95); display:flex; align-items:center; padding:0 1rem; z-index:1000;}
  header .logo{width:40px;height:40px;background:linear-gradient(135deg,var(--accent-blue),var(--accent-orange)); display:flex;align-items:center;justify-content:center; font-weight:700; color:#071523; border-radius:8px; margin-right:.5rem;}
  header h1{font-size:1.2rem;margin:0;}
  .tabs{display:flex; gap:1rem; margin:80px 1rem 1rem;}
  .tabs button{padding:.5rem 1rem; border:none; cursor:pointer; border-radius:8px; background:rgba(255,255,255,0.05); color:var(--muted);}
  .tabs button.active{background:var(--accent-blue); color:#071523;}
  .collection-section{display:none; margin:1rem;}
  .collection-section.active{display:block;}
  table{width:100%; border-collapse:collapse; margin-top:.5rem;}
  th, td{padding:.5rem .7rem; border-bottom:1px solid rgba(255,255,255,0.1);}
  tr:hover{background: rgba(42,164,255,0.05);}
  form{margin-top:1rem; display:flex; flex-direction: column; gap:.5rem; padding:1rem; background:var(--card-dark); border-radius:var(--radius);}
  form input, form textarea{padding:.5rem; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); color:var(--text-light);}
  form label{font-size:.85rem; color:var(--muted);}
  form button{cursor:pointer; border-radius:8px; padding:.5rem 1rem; font-weight:600; background:var(--accent-blue); color:#071523; border:none;}
</style>
</head>
<body>

<header>
  <div class="logo">A</div>
  <h1>Admin Panel</h1>
</header>

<!-- Onglets -->
<div class="tabs">
  <button data-tab="scenariste-projects" class="active">Sc√©nariste Projects</button>
  <button data-tab="realisation">R√©alisation</button>
  <button data-tab="web-projects">Web Projects</button>
  <button data-tab="contact-messages">Contact Messages</button>
</div>

<div class="content">

  <!-- SCENARISTE PROJECTS -->
  <section id="scenariste-projects" class="collection-section active">
    <h3>Sc√©nariste Projects</h3>
    <form id="scenariste-form">
      <label>Title</label><input type="text" id="scenariste-title" required>
      <label>Type</label><input type="text" id="scenariste-type" required>
      <label>Genre</label><input type="text" id="scenariste-genre" required>
      <label>Year</label><input type="number" id="scenariste-year" required>
      <label>Status</label><input type="text" id="scenariste-status" required>
      <label>Tags (comma separated)</label><input type="text" id="scenariste-tags">
      <label>Image URL</label><input type="text" id="scenariste-imageUrl">
      <label>Video URL</label><input type="text" id="scenariste-videoUrl">
      <label>Pitch</label><input type="text" id="scenariste-pitch" required>
      <label>Synopsis</label><textarea id="scenariste-synopsis"></textarea>
      <label><input type="checkbox" id="scenariste-isPortfolio"> Is Portfolio</label>
      <label>Highlight Order</label><input type="number" id="scenariste-highlightOrder">
      <button type="submit">Ajouter / Modifier</button>
    </form>
    <table>
      <thead>
        <tr>
          <th>Title</th><th>Type</th><th>Genre</th><th>Year</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="scenariste-projects-body"></tbody>
    </table>
  </section>

  <!-- REALISATION -->
  <section id="realisation" class="collection-section">
    <h3>R√©alisation</h3>
    <form id="realisation-form">
      <label>Title</label><input type="text" id="realisation-title" required>
      <label>Pitch</label><input type="text" id="realisation-pitch" required>
      <label>With</label><input type="text" id="realisation-with">
      <label>URL</label><input type="text" id="realisation-url">
      <label>Synopsis</label><textarea id="realisation-synopsis"></textarea>
      <button type="submit">Ajouter / Modifier</button>
    </form>
    <table>
      <thead>
        <tr><th>Title</th><th>Pitch</th><th>With</th><th>Actions</th></tr>
      </thead>
      <tbody id="realisation-body"></tbody>
    </table>
  </section>

  <!-- WEB PROJECTS -->
  <section id="web-projects" class="collection-section">
    <h3>Web Projects</h3>
    <form id="web-form">
      <label>Name</label><input type="text" id="web-name" required>
      <label>Description</label><input type="text" id="web-description">
      <label>Stack (comma separated)</label><input type="text" id="web-stack">
      <label>Lien</label><input type="text" id="web-lien">
      <label>Image URL</label><input type="text" id="web-imageUrl">
      <label>Tags (comma separated)</label><input type="text" id="web-tags">
      <button type="submit">Ajouter / Modifier</button>
    </form>
    <table>
      <thead>
        <tr><th>Name</th><th>Stack</th><th>Actions</th></tr>
      </thead>
      <tbody id="web-projects-body"></tbody>
    </table>
  </section>

  <!-- CONTACT MESSAGES -->
  <section id="contact-messages" class="collection-section">
    <h3>Contact Messages</h3>
    <table>
      <thead>
        <tr><th>Name</th><th>Email</th><th>Message</th><th>Date</th><th>View</th><th>Actions</th></tr>
      </thead>
      <tbody id="contact-messages-body"></tbody>
    </table>
  </section>

</div>

<script>
  // Onglets
  const tabs = document.querySelectorAll('.tabs button');
  const sections = document.querySelectorAll('.collection-section');
  tabs.forEach(tab=>{
    tab.addEventListener('click',()=>{
      tabs.forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.dataset.tab;
      sections.forEach(s=>{
        s.classList.toggle('active', s.id === target);
      });
    });
  });
</script>
<script type="module">
// --- Firebase imports ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { 
  getFirestore, collection, doc, getDoc, onSnapshot, addDoc, updateDoc, deleteDoc 
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

// --- Configuration Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyA3YY-YkJ4tfSiBF1I_M8UVhxyzfMN5238",
  authDomain: "es-portfolio-a6c08.firebaseapp.com",
  projectId: "es-portfolio-a6c08",
  storageBucket: "es-portfolio-a6c08.firebasestorage.app",
  messagingSenderId: "342830960639",
  appId: "1:342830960639:web:be05ff6d2996dff20a21ca"
};

// --- Init Firebase ---
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ==================== üîê V√âRIFICATION ACC√àS ADMIN ====================
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  try {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists() || userDoc.data().role !== "admin") {
      alert("Acc√®s refus√© : vous n'avez pas les droits administrateurs.");
      window.location.href = "404.html";
      return;
    }

    // L'utilisateur est admin ‚Üí on peut charger les donn√©es
    loadScenaristeProjects();
    loadRealisation();
    loadWebProjects();
    loadContactMessages();

  } catch (err) {
    console.error("Erreur de v√©rification admin :", err);
    window.location.href = "404.html";
  }
});

// ==================== üé¨ SCENARISTE PROJECTS ====================
let currentScenaristeId = null;
const scenForm = document.getElementById("scenariste-form");
const scenBody = document.getElementById("scenariste-projects-body");

function loadScenaristeProjects() {
  onSnapshot(collection(db, "scenariste_projects"), (snapshot) => {
    scenBody.innerHTML = "";
    snapshot.forEach((docSnap) => {
      const d = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.title}</td>
        <td>${d.type}</td>
        <td>${d.genre}</td>
        <td>${d.year}</td>
        <td>${d.status}</td>
        <td>
          <button class="edit-btn">‚úèÔ∏è</button>
          <button class="delete-btn">üóëÔ∏è</button>
        </td>
      `;
      scenBody.appendChild(tr);

      tr.querySelector(".edit-btn").addEventListener("click", () => {
        currentScenaristeId = docSnap.id;
        scenForm["scenariste-title"].value = d.title;
        scenForm["scenariste-type"].value = d.type;
        scenForm["scenariste-pitch"].value = d.pitch;
        scenForm["scenariste-genre"].value = d.genre;
        scenForm["scenariste-year"].value = d.year;
        scenForm["scenariste-status"].value = d.status;
        scenForm["scenariste-tags"].value = d.tags?.join(", ") || "";
        scenForm["scenariste-imageUrl"].value = d.imageUrl || "";
        scenForm["scenariste-videoUrl"].value = d.videoUrl || "";
        scenForm["scenariste-synopsis"].value = d.synopsis || "";
        scenForm["scenariste-isPortfolio"].checked = d.isPortfolio || false;
        scenForm["scenariste-highlightOrder"].value = d.highlightOrder || 0;
      });

      tr.querySelector(".delete-btn").addEventListener("click", async () => {
        if (confirm("Supprimer ce projet ?")) {
          await deleteDoc(doc(db, "scenariste_projects", docSnap.id));
        }
      });
    });
  });
}

scenForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = {
    title: scenForm["scenariste-title"].value,
    pitch: scenForm["scenariste-pitch"].value,
    type: scenForm["scenariste-type"].value,
    genre: scenForm["scenariste-genre"].value,
    year: Number(scenForm["scenariste-year"].value),
    status: scenForm["scenariste-status"].value,
    tags: scenForm["scenariste-tags"].value.split(",").map(t => t.trim()).filter(t => t),
    imageUrl: scenForm["scenariste-imageUrl"].value,
    videoUrl: scenForm["scenariste-videoUrl"].value,
    synopsis: scenForm["scenariste-synopsis"].value,
    isPortfolio: scenForm["scenariste-isPortfolio"].checked,
    highlightOrder: Number(scenForm["scenariste-highlightOrder"].value) || 0
  };

  if (currentScenaristeId) {
    await updateDoc(doc(db, "scenariste_projects", currentScenaristeId), data);
    currentScenaristeId = null;
  } else {
    await addDoc(collection(db, "scenariste_projects"), data);
  }
  scenForm.reset();
});

// ==================== üé• REALISATION ====================
let currentRealId = null;
const realForm = document.getElementById("realisation-form");
const realBody = document.getElementById("realisation-body");

function loadRealisation() {
  onSnapshot(collection(db, "scenariste-realisation"), (snapshot) => {
    realBody.innerHTML = "";
    snapshot.forEach((docSnap) => {
      const d = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.title}</td>
        <td>${d.pitch}</td>
        <td>${d.with}</td>
        <td>
          <button class="edit-btn">‚úèÔ∏è</button>
          <button class="delete-btn">üóëÔ∏è</button>
        </td>
      `;
      realBody.appendChild(tr);

      tr.querySelector(".edit-btn").addEventListener("click", () => {
        currentRealId = docSnap.id;
        realForm["realisation-title"].value = d.title;
        realForm["realisation-pitch"].value = d.pitch;
        realForm["realisation-with"].value = d.with;
        realForm["realisation-url"].value = d.url;
        realForm["realisation-synopsis"].value = d.synopsis;
      });

      tr.querySelector(".delete-btn").addEventListener("click", async () => {
        if (confirm("Supprimer cette r√©alisation ?")) {
          await deleteDoc(doc(db, "scenariste-realisation", docSnap.id));
        }
      });
    });
  });
}

realForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = {
    title: realForm["realisation-title"].value,
    pitch: realForm["realisation-pitch"].value,
    with: realForm["realisation-with"].value,
    url: realForm["realisation-url"].value,
    synopsis: realForm["realisation-synopsis"].value
  };

  if (currentRealId) {
    await updateDoc(doc(db, "scenariste-realisation", currentRealId), data);
    currentRealId = null;
  } else {
    await addDoc(collection(db, "scenariste-realisation"), data);
  }
  realForm.reset();
});

// ==================== üíª WEB PROJECTS ====================
let currentWebId = null;
const webForm = document.getElementById("web-form");
const webBody = document.getElementById("web-projects-body");

function loadWebProjects() {
  onSnapshot(collection(db, "web_projects"), (snapshot) => {
    webBody.innerHTML = "";
    snapshot.forEach((docSnap) => {
      const d = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.name}</td>
        <td>${d.stack}</td>
        <td>
          <button class="edit-btn">‚úèÔ∏è</button>
          <button class="delete-btn">üóëÔ∏è</button>
        </td>
      `;
      webBody.appendChild(tr);

      tr.querySelector(".edit-btn").addEventListener("click", () => {
        currentWebId = docSnap.id;
        webForm["web-name"].value = d.name;
        webForm["web-description"].value = d.description;
        webForm["web-stack"].value = Array.isArray(d.stack) ? d.stack.join(", ") : d.stack;
        webForm["web-lien"].value = d.lien;
        webForm["web-imageUrl"].value = d.imageUrl;
        webForm["web-tags"].value = d.tags?.join(", ") || "";
      });

      tr.querySelector(".delete-btn").addEventListener("click", async () => {
        if (confirm("Supprimer ce projet web ?")) {
          await deleteDoc(doc(db, "web_projects", docSnap.id));
        }
      });
    });
  });
}

webForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = {
    name: webForm["web-name"].value,
    description: webForm["web-description"].value,
    stack: webForm["web-stack"].value.split(",").map(s => s.trim()).filter(s => s),
    lien: webForm["web-lien"].value,
    imageUrl: webForm["web-imageUrl"].value,
    tags: webForm["web-tags"].value.split(",").map(t => t.trim()).filter(t => t)
  };

  if (currentWebId) {
    await updateDoc(doc(db, "web_projects", currentWebId), data);
    currentWebId = null;
  } else {
    await addDoc(collection(db, "web_projects"), data);
  }
  webForm.reset();
});

// ==================== üì© CONTACT MESSAGES ====================
const contactBody = document.getElementById("contact-messages-body");

function loadContactMessages() {
  onSnapshot(collection(db, "contact_messages"), (snapshot) => {
    contactBody.innerHTML = "";
    snapshot.forEach((docSnap) => {
      const d = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.name}</td>
        <td>${d.email}</td>
        <td>${d.message}</td>
        <td>${d.date ? new Date(d.date.seconds * 1000).toLocaleString() : ""}</td>
        <td>${d.view ? "‚úÖ" : "üëÅÔ∏è"}</td>
        <td><button class="delete-btn">üóëÔ∏è</button></td>
      `;
      contactBody.appendChild(tr);

      tr.querySelector(".delete-btn").addEventListener("click", async () => {
        if (confirm("Supprimer ce message ?")) {
          await deleteDoc(doc(db, "contact_messages", docSnap.id));
        }
      });
    });
  });
}
</script>
</body>
</html>
